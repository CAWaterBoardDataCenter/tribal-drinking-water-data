---
title: "Tribal Drinking Water - Data Exploration and Processing"
output: 
  html_document:
    toc: true # table of contents true
    toc_depth: 3  # upto three depths of headings (specified by #, ## and ###)
    number_sections: true  ## if you want number sections at each table header
    theme: united 
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(tigris)
library(ggplot2)
library(ggthemes)
library(sf)
library(here)
library(readxl)
library(janitor)
library(kableExtra)
library(archive)
library(esri2sf) # install using remotes::install_github("yonghah/esri2sf"); for more info see: https://github.com/yonghah/esri2sf 


# Define coordinate systems to use for transformations (use projected coordinates for geoprocessing)
crs_projected <- 3310 # see: https://epsg.io/3310 
```



# Tribal Boundaries

Data on boundaries for tribal areas within California is available from multiple sources (we need to determine which, if any, is the 'official' dataset to use for SWRCB projects). Here are some potential sources:

1.   Census Bureau's American Indian / Alaska Native / Native Hawaiian Areas shapefile (can be accessed via the `tigris` R package)
2.   Governor's Office of Emergency Services GIS Data Hub | Indian Lands and Native Entities (may be the same as above): https://gis-calema.opendata.arcgis.com/datasets/23348a6fb3e44322a0c0a862aba62a24_0/explore?location=37.186500%2C-120.308500%2C5.85
3.   USA Native Lands (Water Board's Authoritative Source?): <https://services.arcgis.com/P3ePLMYs2RVChkJx/ArcGIS/rest/services/USA_Native_Lands_View/FeatureServer/0>
4.   Map depicting the boundaries of Native American reservations and rancherias as mapped by the Bureau of Indian Affairs, created for the Governor's Office of the Tribal Advisor by the California Technology Agency/GIS Unit: https://services.gis.ca.gov/arcgis/rest/services/Government/NativeLandsBoundaries/MapServer 
5.   Bureau of Indian Affairs: <https://biamaps.doi.gov/bogs/datadownload.html>


## Census Bureau Data
All analysis/processing below uses the boundaries from the US Census Bureau.

Here's the Census Bureau's description of this dataset: "This shapefile contain both legal and statistical American Indian, Alaska Native, and Native Hawaiian entities for which the Census Bureau publishes data. The legal entities consist of federally recognized American Indian reservations and off-reservation trust land areas, state-recognized American Indian reservations, and Hawaiian home lands (HHLs)." [More Info](https://www2.census.gov/geo/pdfs/reference/GARM/Ch5GARM.pdf)

```{r tribal-boundaries-census, message=FALSE}
# get state boundary ----
## source
# states(year = 2020, progress_bar = FALSE) %>% 
#     filter(STUSPS == 'CA') %>% 
#     st_transform(crs_projected) %>% 
#     st_write(here('data_processed', 'ca_boundary.gpkg'))

## read
sf_california <- st_read(here('data_processed', 'ca_boundary.gpkg'))


# get tribal data (all of US) ----
## source
# native_areas(cb = TRUE, year = 2020, progress_bar = FALSE) %>%
#     st_transform(crs_projected) %>%
#     st_filter(sf_california) %>% 
#     st_write(here('data_processed', 'native_areas_census.gpkg'), 
#              append = FALSE)

## read
sf_native_areas_census <- st_read(here('data_processed', 'native_areas_census.gpkg'))
# View(sf_native_areas_census %>% st_drop_geometry())


# map ----
# ca_boundary <- map_data('state') %>% 
#     filter(region == 'california')
gg <- ggplot() + 
    # geom_polygon(data = ca_boundary, 
    #              mapping = aes(x = long, y = lat, group = group), 
    #              fill = NA, color = 'black') +
    geom_sf(data = sf_california) +
    theme_map() + 
    # coord_fixed(1.3) +
    geom_sf(data = sf_native_areas_census, color = 'black', fill = 'black') + #, size=0.25) +
    # coord_sf(xlim=c(-124.409591, -114.131211),
    #          ylim=c(32.534156, 42.009518)) +
    NULL
gg

# # write to shapefile
# suppressWarnings(
#     st_write(sf_native_areas_census, 
#              here('data_processed', 'tribal_boundaries_census', 'tribal_boundaries_census.shp'), 
#              quiet = TRUE)
# )

# # write to shapefile - state boundary
# suppressWarnings(
#     st_write(sf_california,
#              here('data_processed', 'ca_boundary', 'ca_boundary.shp'),
#              quiet = TRUE)
# )
```

```{r}
sf_native_areas_census %>%
    st_drop_geometry() %>% 
    kbl() %>%
    kable_paper() %>%
    scroll_box(width = "1000px", height = "200px") %>%
    {.}
```


## BIA Data

<https://biamaps.doi.gov/bogs/datadownload.html>

NOTE: when we originally accessed the BIA tribal boundaries dataset in Feburuary 2022, the dataset was available to download as a shapefile, which is reflected in the code chunk below. However, as of September 2022, it appears that the data is only available via a REST service, so the code in the chunk below will likely no longer work to download the data, and this version of the dataset is no longer used in the shiny app. See the code chunk that follows it for an example of how to access the data via the REST service, which is how the data was obtained for use in the shiny app.

```{r}
# # get data as shapefile (February 2022) ----
# ## download
# download.file(url = 'https://biamaps.doi.gov/files/BIA_National_LAR_shp.zip', 
#               destfile = here('data', 'BIA_National_LAR_shp.zip'), 
#               quiet = TRUE)
# unzip(zipfile = here('data', 'BIA_National_LAR_shp.zip'), 
#       junkpaths = TRUE, 
#       exdir = here('data', 'BIA_National_LAR_shp'))
# 
# ## read and filter for CA ----
# sf_tribal_bia <- st_read(here('data', 'BIA_National_LAR_shp', 'BIA_National_LAR.shp'),
#                          quiet = TRUE) %>%
#     st_transform(crs_projected) %>%
#     st_filter(sf_california)
# 
# ## write ----
# st_write(sf_tribal_bia, here('data_processed', 'BIA_National_LAR.gpkg'))

# read
# sf_tribal_bia <- st_read(here('data_processed', 'BIA_National_LAR.gpkg'), 
#                          quiet = TRUE)
# # View(sf_tribal_bia %>% st_drop_geometry())
# 
# plot(sf_tribal_bia$geom) + plot(sf_california$geom, add = TRUE)
# 
# # View(sf_tribal_bia %>% st_drop_geometry())
```

The code chunk below shows how to access the BIA boundary dataset via the REST service. This version of the dataset is used in the shiny app.

```{r}
# uncomment the code below to download and process the dataset
# sf_tribal_bia <- esri2sf(
#     url = 'https://biamaps.doi.gov/server/rest/services/DivLTR/BIA_AIAN_National_LAR/MapServer/0', 
#     crs = NULL) %>% 
#     rename(geom = geoms)
# 
# # filter for tribal areas in CA
# sf_tribal_bia <- sf_tribal_bia %>% 
#     st_transform(crs_projected) %>%
#     st_filter(sf_california)
# 
# st_write(sf_tribal_bia, 
#          here('data_processed', 'native_areas_bia.gpkg'))
```

As a check, here's a plot of the BIA tribal boundaries in California.

```{r}
# read
sf_tribal_bia <- st_read(here('data_processed', 'native_areas_bia.gpkg'), 
                         quiet = TRUE)
# View(sf_tribal_bia %>% st_drop_geometry())

plot(sf_tribal_bia$geom) + plot(sf_california$geom, add = TRUE)
```


# Mobile Home Data

Potential data sources:

-   A list of mobile home / RV parks in California is available from the California Department of Housing and Community Development, at: <https://casas.hcd.ca.gov/casas/cmirMp/onlineQuery> (NOTE: this data has to be downloaded manually, because it requires entering a security code to view, and no direct link to the data download is available. To download the data, leave all criteria fields blank and click the "Export to Excel" button.)
-   A national-level shapefile of Mobile Home Parks is available at: <https://hifld-geoplatform.opendata.arcgis.com/datasets/geoplatform::mobile-home-parks/about> (click the 'Download' button then select 'Shapefile'). I think this is developed by the Department of Homeland Security.

## Tabular Data (CA Dept of Housing)
```{r mobile-homes-tabular}
# tabular data (from CA Dept of Housing)
df_mobilehome <- read_excel(here('data', 'cmir-mp-park-query-2022_02_14.xls'))
# glimpse(df_mobilehome)

df_mobilehome %>%
    kbl() %>%
    kable_paper() %>%
    scroll_box(width = "1000px", height = "200px") %>%
    {.}
```

There are *`r nrow(df_mobilehome)`* total mobile home parks in the CA Dept of Housing database.

## Geospatial Data (DHS)
```{r mobile-homes-shape}
# shapefile
sf_mobile_home <- st_read(here('data', 'Mobile_Home_Parks', 'MobileHomeParks.shp')) %>% 
    filter(STATE == 'CA') %>% 
    # filter(TYPE == 'MOBILE HOME PARK') %>% 
    st_transform(crs_projected)

nrow_mobhome_dhs <- nrow(sf_mobile_home)

# filter for mobile home parks in tribal areas
sf_mobile_home <- sf_mobile_home %>% 
    st_filter(sf_native_areas_census)

# # filter for TYPE = "MOBILE HOME PARK" (filter out "RECREATIONAL VEHICLE PARK")
# sf_mobile_home <- sf_mobile_home %>% 
#     filter(TYPE == 'MOBILE HOME PARK')

# plot
plot(sf_california$geom) + 
    plot(sf_native_areas_census$geom, col = 'black', add = TRUE) + 
    plot(sf_mobile_home$geometry, col = 'green', add = TRUE)

# # write to shapefile
# suppressWarnings(
#     st_write(sf_mobile_home,
#              here('data_processed', 'mobile_homes_filtered', 'mobile_homes_filtered.shp'),
#              quiet = TRUE)
# )
```

There are *`r nrow_mobhome_dhs`* total California mobile home parks in the DHS database, and *`r nrow(sf_mobile_home)`* are within the tribal boundaries.

Tabular data (mobile home parks within CA tribal boundaries):
```{r}
sf_mobile_home %>%
    st_drop_geometry() %>% 
    kbl() %>%
    kable_paper() %>%
    scroll_box(width = "1000px", height = "200px") %>%
    {.}
```



# Drinking Water Data

Data Sources:

-   CA GIS data portal: <https://gis.data.ca.gov/search?groupIds=328cf900903945978695b3ff6ae95db7&type=feature%20layer%2Cfeature%20service>
-   Water Board GIS Portal (multiple - see below): <https://gispublic.waterboards.ca.gov/portal/home>


## System Boundaries

This dataset is not currently used in any of our analysis. It is available at:
<https://gispublic.waterboards.ca.gov/portal/home/item.html?id=fbba842bf134497c9d611ad506ec48cc>

```{r drinking-water-boundaries}
# drinking water boundaries
# from: https://gispublic.waterboards.ca.gov/portal/home/item.html?id=fbba842bf134497c9d611ad506ec48cc
# url_dw_boundary <- paste0('https://gispublic.waterboards.ca.gov/portalserver/rest/services/Drinking_Water/California_Drinking_Water_System_Area_Boundaries/FeatureServer/0',
#             '/query?where=1=1&outFields=*&outSR=4326&f=geojson')
# sf_dw_boundary <- readLines(url_dw_boundary) %>% 
#     geojson_sf()
# sf_dw_boundary %>% st_drop_geometry() %>% View()
```


## System Locations

This dataset is not currently used in any of our analysis. It is available at:
<https://gispublic.waterboards.ca.gov/portal/home/item.html?id=346d649d1e654737ac5b6855466e89b2>

It's also on the state geoportal here: <https://gis.data.ca.gov/maps/waterboards::water-system-outreach-public/explore>

```{r drinking-water-system-locations}
# California Drinking Water System Locations
# from: <https://gispublic.waterboards.ca.gov/portal/home/item.html?id=346d649d1e654737ac5b6855466e89b2>
# NOTE: Downloaded by clicking on "Open in ArcGIS Desktop" then saving the layer as a shapefile from there (could download via geojson, but would need to figure out how to work around the limit on max # of records)
sf_dw_system_loc <- st_read(here('data', 'CA_ws_20220114_Clip', 'CA_ws_20220114_Clip.shp')) %>% 
    st_transform(crs_projected)
# sf_dw_system_loc %>% st_drop_geometry() %>% View()
sf_dw_system_loc_tribal <- sf_dw_system_loc %>% 
    st_filter(sf_native_areas_census)
# sf_dw_system_loc_tribal %>% st_drop_geometry() %>% View()
# sf_dw_system_loc_tribal %>% st_drop_geometry() %>% filter(system_typ == 'STATE SMALL WATER SYSTEM') %>% View()

# fix invalid geometry
if (sum(!st_is_valid(sf_dw_system_loc_tribal)) > 0) {
    sf_dw_system_loc_tribal <- st_make_valid(sf_dw_system_loc_tribal)
}
# sum(!st_is_valid(sf_dw_system_loc_tribal))

plot(sf_california$geom) + 
    plot(sf_native_areas_census$geom, add = TRUE, col = 'black') + 
    plot(sf_dw_system_loc_tribal$geometry, add = TRUE, col = 'blue')


# # write to shapefile
# suppressWarnings(
#     st_write(sf_dw_system_loc_tribal_2, 
#              here('data_processed', 'drinking_water_systems_filtered', 
#                   'drinking_water_systems_filtered.shp'), 
#              quiet = TRUE)
# )
```

Tabular data (water systems / aquifers overlapping tribal boundaries):

```{r}
sf_dw_system_loc_tribal %>%
    st_drop_geometry() %>% 
    kbl() %>%
    kable_paper() %>%
    scroll_box(width = "1000px", height = "200px") %>%
    {.}
```


## Combined Risk

This dataset is not currently used in any of our analysis. It is available at:
<https://gis.data.ca.gov/datasets/waterboards::combined-risk/about>

```{r }

```


## Combined Risk By Well

This dataset is not currently used in any of our analysis. See the "Water Quality Risk Final - Water Quality Risk by Well (All Contaminants)" dataset below for the version that is used in the shiny app. 

This dataset is available at:
<https://gis.data.ca.gov/datasets/waterboards::water-quality-risk-by-well-all-chemicals/about>

```{r drinking-water-by-well}
# water quality risk by well
# <https://gis.data.ca.gov/datasets/waterboards::water-quality-risk-by-well-all-chemicals/about>
sf_dw_domestic_well <- st_read(here('data', 'Domestic_Depth_Groundwater_Quality_(Water_Quality_Risk)', 'Domestic_Depth_Groundwater_Quality_(Water_Quality_Risk).shp')) %>% 
    st_transform(crs_projected)
# sf_dw_domestic_well %>% st_drop_geometry() %>% count(source)

# wells on tribal land
sf_dw_domestic_well_tribal <- sf_dw_domestic_well %>% 
    st_filter(sf_native_areas_census)
# sf_dw_domestic_well_tribal %>% st_drop_geometry() %>% View()

# high & medium risk wells
# sf_dw_domestic_well_tribal %>% st_drop_geometry() %>% filter(risk != 'low') %>% View()

# plot
plot(sf_california$geom) + 
    plot(sf_native_areas_census$geom, col = 'black', add = TRUE) + 
    sf_dw_domestic_well_tribal %>% filter(risk == 'low') %>% pull(geometry) %>% plot(col = 'blue', add = TRUE) +
    sf_dw_domestic_well_tribal %>% filter(risk == 'medium') %>% pull(geometry) %>% plot(col = 'orange', add = TRUE) +
    sf_dw_domestic_well_tribal %>% filter(risk == 'high') %>% pull(geometry) %>% plot(col = 'red', add = TRUE)

# # write to shapefile
# suppressWarnings(
#     st_write(sf_dw_domestic_well_tribal, 
#              here('data_processed', 'wells_filtered', 
#                   'wells_filtered.shp'), 
#              quiet = TRUE)
# )
```

Tabular data (wells within tribal boundaries):
```{r}
sf_dw_domestic_well_tribal %>%
    st_drop_geometry() %>% 
    kbl() %>%
    kable_paper() %>%
    scroll_box(width = "1000px", height = "200px")
```

Count of wells by risk level:
```{r}
sf_dw_domestic_well_tribal %>% 
    st_drop_geometry() %>% 
    count(risk) %>% 
    # kbl() %>%
    # kable_paper() %>% 
    # scroll_box(width = "200px", height = "100px") %>% 
    {.}
```


## DWR OSWCR Well Data

This dataset is not currently used in any of our analysis. It is available at: <https://data.cnra.ca.gov/dataset/647afc02-8954-426d-aabd-eff418d2652c/resource/8da7b93b-4e69-495d-9caa-335691a1896b>

```{r}
# # source data
# temp_dir <- tempdir()
# download.file(url = 'https://data.cnra.ca.gov/dataset/647afc02-8954-426d-aabd-eff418d2652c/resource/8da7b93b-4e69-495d-9caa-335691a1896b/download/wellcompletionreports.csv', 
#               destfile = file.path(temp_dir, 'wellcompletionreports.csv'))
# # write to zip file
# archive_write_files(archive = here('data', 'wellcompletionreports.zip'), 
#                     files = file.path(temp_dir, 'wellcompletionreports.csv'))

# read data
df_dwr_oswcr <- read_csv(here('data', 'wellcompletionreports.zip'),
                         guess_max = 100000)

# investigate / filter
dwr_oswcr_summary <- df_dwr_oswcr %>% 
    count(PLANNEDUSEFORMERUSE) %>% 
    arrange(desc(n)) %>% 
    # filter(!str_detect(string = tolower(PLANNEDUSEFORMERUSE),
    #                    pattern = 'destruction')) %>%
    # filter(str_detect(string = tolower(PLANNEDUSEFORMERUSE),
    #                   pattern = 'domestic')) %>%
    # filter(n > 10) %>% 
    {.}
# View(dwr_oswcr_summary)

dwr_oswcr_summary %>% 
    # st_drop_geometry() %>% 
    # count(risk) %>% 
    kbl() %>%
    kable_paper() %>%
    scroll_box(width = "300px", height = "200px") %>%
    {.}

# # convert to sf ---
# sf_dwr_oswcr <- st_as_sf(df_dwr_oswcr %>% 
#                              filter(!is.na(as.numeric(DECIMALLONGITUDE)), 
#                                     !is.na(as.numeric(DECIMALLATITUDE))), 
#                          coords = c('DECIMALLONGITUDE', 'DECIMALLATITUDE')) %>% 
#     st_set_crs(4326) %>% 
#     st_transform(crs_projected)
# 
# # filter by type and location ----
# sf_dwr_oswcr_filter <- sf_dwr_oswcr %>% 
#     filter(PLANNEDUSEFORMERUSE %in% c('Water Supply Domestic', 
#                                       'Water Supply Public', 
#                                       'Domestic')) %>% 
#     st_filter(sf_native_areas_census)
# 
# plot(sf_california$geom) + plot(sf_dwr_oswcr_filter$geometry, add = TRUE)
# View(sf_dwr_oswcr_filter %>% st_drop_geometry())
# 
# st_write(sf_dwr_oswcr_filter, here('data_processed', 'dwr_oswcr_filter.gpkg'))
```

## Water Quality Risk Final - Water Quality Risk by Well (All Contaminants)

This dataset was used by Alexis in the shiny app (in the "Wells + SSWS" tab). Emily Houlihan pointed him to this dataset as an updated version of the "Combined Risk By Well" dataset mentioned above, and this dataset also categorizes by well type. 

The dataset is avilable at: <https://gispublic.waterboards.ca.gov/portal/home/item.html?id=84dc4363570b42aba392952d8974c8ab>
Note that you have to then go to the "Water Quality Risk by Well (All Contaminants)" layer to get the well data.

```{r}
# # uncomment the code below to download and process the dataset
# # get data
# sf_wells_wq_risk <- esri2sf(
#     url = 'https://gispublic.waterboards.ca.gov/portalserver/rest/services/Hosted/Water_Quality_Risk_Final/FeatureServer/0',
#     crs = NULL)
# 
# # rename / reorder fields
# sf_wells_wq_risk <- sf_wells_wq_risk %>%
#     rename(geom = geoms) %>%
#     select(gm_well_id, prf1, prf2, prf3, pl1, pl2,
#            risk, gm_latitud, gm_longitu, gm_well_ca,
#            gm_dataset, mtrs, globalid, geom)
# 
# # write to geopackage file
# st_write(sf_wells_wq_risk,
#          here('data_processed', 'wells.gpkg'),
#          append = FALSE)
```

As a check, here's a plot of the wells that are within the Census Bureau boundaries: 

```{r}
sf_wells_wq_risk <- st_read(here('data_processed', 'wells.gpkg')) %>% 
    st_transform(crs_projected)

sf_wells_tribal <- sf_wells_wq_risk %>% 
    st_filter(sf_native_areas_census)

plot(sf_california$geom) + 
    plot(sf_wells_tribal$geom, col = 'blue', add = TRUE)
```


## State Small Water Systems

This dataset was used by Alexis in the shiny app (in the "Wells + SSWS" tab). 

The dataset is avilable at: <https://gispublic.waterboards.ca.gov/portal/home/item.html?id=2d34d39f75b8491d88adda57adb837ec&fromSearch=true&searchPosition=1&searchTerm=small%20state%20water%20systems>

```{r}
# # uncomment the code below to download and process the dataset
# # get data
# sf_ssws <- esri2sf(
#     url = 'https://gispublic.waterboards.ca.gov/portalserver/rest/services/Hosted/State_Small_Water_Systems_DDW/FeatureServer/0',
#     crs = NULL)
# 
# # rename / reorder fields
# sf_ssws <- sf_ssws %>%
#     rename(geom = geoms) %>%
#     select(target_fid, pwsid, system_nam, related_ag, phys_addre,
#            phys_city, phys_state, phys_zip, address, phys_count,
#            admin_cont, admin_emai, admin_addr, admin_add2, admin_city,
#            admin_stat, admin_zip, service_co, population, svc_area_t,
#            owner_type, latitude, longitude, geoaddress, confidence,
#            geocode_me, geocode_ty, match_code, mtrs, srf1, srf2,
#            srf3, sl1, sl2, wqrskbn, globalid, geom)
# 
# # write to geopackage file
# st_write(sf_ssws,
#          here('data_processed', 'SSWS.gpkg'),
#          append = FALSE)
```

As a check, here's a plot of the wells that are within the Census Bureau boundaries: 

```{r}
sf_ssws <- st_read(here('data_processed', 
                        'SSWS.gpkg')) %>% 
    st_transform(crs_projected)

sf_ssws_tribal <- sf_ssws %>% 
    st_filter(sf_native_areas_census)

plot(sf_california$geom) + 
    plot(sf_ssws_tribal$geom, col = 'blue', add = TRUE)
```
