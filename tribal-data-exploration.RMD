---
title: "Tribal Drinking Water - Data Exploration and Processing"
output: 
  html_document:
    toc: true # include table of contents
    toc_depth: 3  # depth of headings in TOC (headings specified by #, ##, ###, ...)
    number_sections: true  # if you want number sections at each table header
    # theme: united 
    keep_html: true # needed to keep the html file, since the output will produce a md file formatted for github 
always_allow_html: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(tigris)
library(ggthemes)
library(sf)
library(here)
library(readxl)
library(janitor)
library(kableExtra)
library(archive)
library(esri2sf) # install using remotes::install_github("yonghah/esri2sf"); for more info see: https://github.com/yonghah/esri2sf 


# Define coordinate systems to use for transformations (use projected coordinates for geoprocessing)
crs_projected <- 3310 # see: https://epsg.io/3310 
```


# State Boundary

Get California boundary:

```{r state-boundary}
# get state boundary ----
## source
# states(year = 2020, progress_bar = FALSE) %>% 
#     filter(STUSPS == 'CA') %>% 
#     st_transform(crs_projected) %>% 
#     st_write(here('data_processed', 'ca_boundary.gpkg'))

## read
sf_california <- st_read(here('data_processed', 'ca_boundary.gpkg'), 
                         quiet = TRUE)
```


# Tribal Boundaries

Tribal boundary datasets for California are available from multiple sources, many of which differ somewhat in terms of the spatial representation of the boundaries and/or the attribute data they contain. Here are some potential sources:

- U.S. Census Bureau's American Indian / Alaska Native / Native Hawaiian Areas: can be accessed via the `tigris` R package (`tigris::native_areas()`), or accessed manually at (I think this is the same, but not entirely certain) <https://www.census.gov/cgi-bin/geo/shapefiles/index.php?year=2020&layergroup=American+Indian+Area+Geography>
- Bureau of Indian Affairs Land Area Representations (LAR):  <https://biamaps.doi.gov/bogs/datadownload.html>
- CA Governor's Office of Emergency Services GIS Data Hub | Indian Lands and Native Entities: <https://gis-calema.opendata.arcgis.com/datasets/23348a6fb3e44322a0c0a862aba62a24_0/explore?location=37.186500%2C-120.308500%2C5.85>
- USA Native Lands: <https://services.arcgis.com/P3ePLMYs2RVChkJx/ArcGIS/rest/services/USA_Native_Lands_View/FeatureServer/0>
- Map depicting the boundaries of Native American reservations and rancherias as mapped by the Bureau of Indian Affairs, created for the Governor's Office of the Tribal Advisor by the California Technology Agency/GIS Unit: <https://services.gis.ca.gov/arcgis/rest/services/Government/NativeLandsBoundaries/MapServer>

The datasets used in the Shiny App are further described below.

## U.S. Census Bureau

All analysis/processing below uses the boundaries from the U.S. Census Bureau.

We used the `tigris` R package to acccess this dataset (with the function `tigris::native_areas()`). It is also available at [this link](https://www.census.gov/cgi-bin/geo/shapefiles/index.php?year=2020&layergroup=American+Indian+Area+Geography) (**NOTE:** I think that's the same as the dataset available via the tigris R package, but not entirely sure that it's exactly the same).

Here's the Census Bureau's description of this dataset: "This shapefile contain both legal and statistical American Indian, Alaska Native, and Native Hawaiian entities for which the Census Bureau publishes data. The legal entities consist of federally recognized American Indian reservations and off-reservation trust land areas, state-recognized American Indian reservations, and Hawaiian home lands (HHLs)." 

More Info can be found [here](https://www2.census.gov/geo/pdfs/reference/GARM/Ch5GARM.pdf).

```{r tribal-boundaries-census-download, message=FALSE}
# get tribal boundaries and filter for areas in CA ----
## source
# native_areas(cb = TRUE, year = 2020, progress_bar = FALSE) %>%
#     st_transform(crs_projected) %>%
#     st_filter(sf_california) %>% 
#     st_write(here('data_processed', 'native_areas_census.gpkg'), 
#              append = FALSE)
```

Here's a map of the Census boundaries:

```{r tribal-boundaries-census-plot, message=FALSE}
## read
sf_native_areas_census <- st_read(here('data_processed', 'native_areas_census.gpkg'), 
                                  quiet = TRUE)
# View(sf_native_areas_census %>% st_drop_geometry())


# map ----
# ca_boundary <- map_data('state') %>% 
#     filter(region == 'california')
plot_boundary_census <- ggplot() + 
    # geom_polygon(data = ca_boundary, 
    #              mapping = aes(x = long, y = lat, group = group), 
    #              fill = NA, color = 'black') +
    geom_sf(data = sf_california) +
    theme_map() + 
    # coord_fixed(1.3) +
    geom_sf(data = sf_native_areas_census, color = 'black', fill = 'black') + #, size=0.25) +
    # coord_sf(xlim=c(-124.409591, -114.131211),
    #          ylim=c(32.534156, 42.009518)) +
    NULL
plot_boundary_census
```

```{r tribal-boundaries-census-shapefile, message=FALSE}
# # process to write the data to a shapefile, if needed
# # write to shapefile
# suppressWarnings(
#     st_write(sf_native_areas_census, 
#              here('data_processed', 'tribal_boundaries_census', 'tribal_boundaries_census.shp'), 
#              quiet = TRUE)
# )

# # write to shapefile - state boundary
# suppressWarnings(
#     st_write(sf_california,
#              here('data_processed', 'ca_boundary', 'ca_boundary.shp'),
#              quiet = TRUE)
# )
```

This table shows the attribute data contained in the Census dataset:

```{r tribal-boundaries-census-attribute}
sf_native_areas_census %>%
    st_drop_geometry() %>% 
    kbl() %>%
    kable_paper() %>%
    scroll_box(width = "1000px", height = "200px") %>%
    {.}
```


## Bureau of Indian Affairs

The U.S. Department of the Interior, Bureau of Indian Affairs' (BIA) Land Area Representations (LAR) dataset is available for download at [this link](https://biamaps.doi.gov/bogs/datadownload.html#H2T2). The data displayed in this tool comes from a copy of the dataset we downloaded in September 2022. 

The BIA's description of the dataset states (in part): "The purpose of the American Indian and Alaska Native Land Area Representation (AIAN-LAR) Geographic Information System (GIS) dataset is to depict the external extent of Federal Indian reservations and the external extent of associated land "held in trust” by the United States, “restricted fee” or “mixed ownership” status for Federally recognized tribes and individual Native Americans. This dataset includes other land area types such as Public Domain Allotments, Dependent Indian Communities and Homesteads." 

More information can be found from the BIA [here](https://biamaps.doi.gov/bogs/datadownload.html#H2T2).

**NOTE:** when we originally accessed the BIA tribal boundaries dataset in Feburuary 2022, the dataset was available to download as a shapefile, which is reflected in the code chunk below. However, as of September 2022, it appears that the data is only available via a REST service, so the code in the chunk below will likely no longer work to download the data, and this version of the dataset is no longer used in the shiny app. See the code chunk that follows it for an example of how to access the data via the REST service, which is how the data was obtained for use in the shiny app.

```{r tribal-boundaries-bia-download-shapefile}
# # get data as shapefile (February 2022) ----
# ## download
# download.file(url = 'https://biamaps.doi.gov/files/BIA_National_LAR_shp.zip', 
#               destfile = here('data', 'BIA_National_LAR_shp.zip'), 
#               quiet = TRUE)
# unzip(zipfile = here('data', 'BIA_National_LAR_shp.zip'), 
#       junkpaths = TRUE, 
#       exdir = here('data', 'BIA_National_LAR_shp'))
# 
# ## read and filter for CA ----
# sf_tribal_bia <- st_read(here('data', 'BIA_National_LAR_shp', 'BIA_National_LAR.shp'),
#                          quiet = TRUE) %>%
#     st_transform(crs_projected) %>%
#     st_filter(sf_california)
# 
# ## write ----
# st_write(sf_tribal_bia, here('data_processed', 'BIA_National_LAR.gpkg'))

# read
# sf_tribal_bia <- st_read(here('data_processed', 'BIA_National_LAR.gpkg'), 
#                          quiet = TRUE)
# # View(sf_tribal_bia %>% st_drop_geometry())
# 
# plot(sf_tribal_bia$geom) + plot(sf_california$geom, add = TRUE)
# 
# # View(sf_tribal_bia %>% st_drop_geometry())
```

The code chunk below shows how to access the BIA boundary dataset via the REST service. This version of the dataset is used in the shiny app.

```{r tribal-boundaries-bia-download-rest}
# uncomment the code below to download and process the dataset
# sf_tribal_bia <- esri2sf(
#     url = 'https://biamaps.doi.gov/server/rest/services/DivLTR/BIA_AIAN_National_LAR/MapServer/0', 
#     crs = NULL) %>% 
#     rename(geom = geoms)
# 
# # filter for tribal areas in CA
# sf_tribal_bia <- sf_tribal_bia %>% 
#     st_transform(crs_projected) %>%
#     st_filter(sf_california)
# 
# st_write(sf_tribal_bia, 
#          here('data_processed', 'native_areas_bia.gpkg'))
```

As a check, here's a plot of the BIA tribal boundaries in California.

```{r tribal-boundaries-bia-plot}
# read
sf_tribal_bia <- st_read(here('data_processed', 'native_areas_bia.gpkg'), 
                         quiet = TRUE)
# View(sf_tribal_bia %>% st_drop_geometry())

plot_boundary_bia <- plot(sf_tribal_bia$geom) + 
    plot(sf_california$geom, add = TRUE)
```


# Mobile Home Data

We found two potential sources of data for mobile home parks in California, which are described below (there may be additional sources we haven't found yet though).

## CA Dept of Housing (Tabular Data Only)

A list of mobile home / RV parks in California is available from the California Department of Housing and Community Development, at: <https://casas.hcd.ca.gov/casas/cmirMp/onlineQuery>. This is the dataset used in the Shiny App.

This data has to be downloaded manually, because it requires entering a security code to view, and no direct link to the data download is available. To download the data, leave all criteria fields blank and click the "Export to Excel" button.

Note that this data only contains addresses, not geospatial coordinates. So, to map the mobile home parks, we used a tool developed by the State Water Board's GIS Unit (Geocoding Toolbox v.1.0 for ArcGIS Pro) to convert addresses to geographic coordinates. As a result, the locations displayed in the Shiny App are estimates, and may not always be highly accurate. The geocoding tool uses the Bing geocoding service. Water Board staff can access the tool on our intranet site [here](http://wiki.waterboards.ca.gov/gis/doku.php#geocoding_toolbox).

Prior to using the geocoding tool, we processed the data and manually verified (using Google Maps) a selection of mobile home park addresses that appeared to be entered or recorded incorrectly. We updated the addresses of four parks and removed one park that did not have a valid or verifiable address. These steps are documented in the Python script `working_files/mobile_home_parks/mobile-home-parks.py` (also available [here](https://github.com/CAWaterBoardDataCenter/tribal-drinking-water-data/blob/main/working_files/mobile_home_parks/mobile-home-parks.py)). 

```{r mobile-homes-ca}
# tabular data (from CA Dept of Housing)
df_mobilehome <- read_excel(here('data', 'cmir-mp-park-query-2022_02_14.xls'))
# glimpse(df_mobilehome)
```

There are *`r nrow(df_mobilehome)`* total mobile home parks in the CA Dept of Housing database. The table below shows the attribute data included in this dataset.

```{r mobile-homes-ca-table}
df_mobilehome %>%
    kbl() %>%
    kable_paper() %>%
    scroll_box(width = "1000px", height = "200px") %>%
    {.}
```

## Department of Homeland Security (Geospatial Data)

A nationalwide dataset of mobile home parks is available from the Department of Homeland Security's  Homeland Infrastructure Foundation Level Data (HIFLD) database. It is available at: <https://hifld-geoplatform.opendata.arcgis.com/datasets/geoplatform::mobile-home-parks/about> (click the 'Download' button then select 'Shapefile'). 

This dataset appears to include data from the CA Dept of Housing dataset mentioned above, and it appears that some validation was done (e.g., using aerial imagery). However, the data for California may not be up to date. Also, this dataset is not that well documented, so we don't know how authoritative it is. As a result, we did not use this dataset in the Shiny App (we used the data from the CA Department Housing described above instead).

```{r mobile-homes-dhs}
# shapefile
sf_mobile_home <- st_read(here('data', 'Mobile_Home_Parks', 'MobileHomeParks.shp'), 
                          quiet = TRUE) %>% 
    filter(STATE == 'CA') %>% 
    # filter(TYPE == 'MOBILE HOME PARK') %>% 
    st_transform(crs_projected)

nrow_mobhome_dhs <- nrow(sf_mobile_home)

# filter for mobile home parks in tribal areas
sf_mobile_home <- sf_mobile_home %>% 
    st_filter(sf_native_areas_census)

# # filter for TYPE = "MOBILE HOME PARK" (filter out "RECREATIONAL VEHICLE PARK")
# sf_mobile_home <- sf_mobile_home %>% 
#     filter(TYPE == 'MOBILE HOME PARK')

# plot
plot_mhp_dhs <- plot(sf_california$geom) + 
    plot(sf_native_areas_census$geom, col = 'black', add = TRUE) + 
    plot(sf_mobile_home$geometry, col = 'green', add = TRUE)

# # write to shapefile
# suppressWarnings(
#     st_write(sf_mobile_home,
#              here('data_processed', 'mobile_homes_filtered', 'mobile_homes_filtered.shp'),
#              quiet = TRUE)
# )
```

There are *`r nrow_mobhome_dhs`* total California mobile home parks in the DHS database, and *`r nrow(sf_mobile_home)`* are within the tribal boundaries.

The table below shows the attribute data included in this dataset.

```{r mobile-homes-dhs-tabular}
sf_mobile_home %>%
    st_drop_geometry() %>% 
    kbl() %>%
    kable_paper() %>%
    scroll_box(width = "1000px", height = "200px") %>%
    {.}
```


# Drinking Water Data

The datasets listed below were some that we identified as part of our data gathering process; some of them were not ultimately used for our analysis/application.

## California Drinking Water System Area Boundaries

This dataset represents service area boundaries boundaries of drinking water service providers, as verified by the Division of Drinking Water, State Water Resources Control Board. It is available at:
<https://gispublic.waterboards.ca.gov/portal/home/item.html?id=fbba842bf134497c9d611ad506ec48cc>

This dataset is not currently used in any of our analysis.

```{r drinking-water-system-boundaries}
# # get data via REST
# sf_dw_boundary <- esri2sf(
#     url = 'https://gispublic.waterboards.ca.gov/portalserver/rest/services/Drinking_Water/California_Drinking_Water_System_Area_Boundaries/FeatureServer/0', 
#     crs = NULL)

# # Alternative method, downloading as GeoJSON (via REST)
# drinking water boundaries
# from: https://gispublic.waterboards.ca.gov/portal/home/item.html?id=fbba842bf134497c9d611ad506ec48cc
# url_dw_boundary <- paste0('https://gispublic.waterboards.ca.gov/portalserver/rest/services/Drinking_Water/California_Drinking_Water_System_Area_Boundaries/FeatureServer/0',
#             '/query?where=1=1&outFields=*&outSR=4326&f=geojson')
# sf_dw_boundary <- readLines(url_dw_boundary) %>% 
#     geojson_sf()

# View tabular data
# sf_dw_boundary %>% st_drop_geometry() %>% View()
```


## California Drinking Water System Locations

This dataset is not currently used in any of our analysis. It is available at:
<https://gispublic.waterboards.ca.gov/portal/home/item.html?id=346d649d1e654737ac5b6855466e89b2>

This dataset is a combination of data sources, including:
- The "California Drinking Water System Area Boundaries" dataset described above
- Public water systems (mostly non-community) that do not yet have a boundary in the "California Drinking Water System Area Boundaries" dataset. These systems have been geocoded from their Physical Locations in the State Drinking Water Information System (SDWIS) portal, with light data cleaning.
- State Small Water Systems (non-public water systems that are regulated by County health officials in partnership with the State Water Board). These systems have been geocoded from their Physical Locations using the most recent County-provided data, with light data cleaning.

It's also on the state geoportal here: <https://gis.data.ca.gov/maps/waterboards::water-system-outreach-public/explore>

```{r drinking-water-system-locations}
# # get data via REST
# sf_dw_system_loc <- esri2sf(
#     url = 'https://gispublic.waterboards.ca.gov/portalserver/rest/services/Hosted/California_Public_Water_System_Locations/FeatureServer/0', 
#     crs = NULL) %>% 
#     st_transform(crs_projected) %>% 
#     rename(geom = geoms)
# # fix invalid geometry
# if (sum(!st_is_valid(sf_dw_system_loc_tribal)) > 0) {
#     sf_dw_system_loc_tribal <- st_make_valid(sf_dw_system_loc_tribal)
# }
# sum(!st_is_valid(sf_dw_system_loc_tribal))
# # write
# st_write(sf_dw_system_loc, 
#          here('data', 'drinking_water_system_loc.gpkg'), 
#          append = FALSE)

sf_dw_system_loc <- st_read(here('data', 'drinking_water_system_loc.gpkg'))

# systems witin tribal boundaries
sf_dw_system_loc_tribal <- sf_dw_system_loc %>% 
    st_filter(sf_native_areas_census)
# sf_dw_system_loc_tribal %>% st_drop_geometry() %>% View()
# sf_dw_system_loc_tribal %>% st_drop_geometry() %>% filter(system_typ == 'STATE SMALL WATER SYSTEM') %>% View()

plot_dw_systems <- plot(sf_california$geom) + 
    plot(sf_native_areas_census$geom, add = TRUE, col = 'black') + 
    plot(sf_dw_system_loc_tribal$geom, add = TRUE, col = 'blue')

# # write to shapefile
# suppressWarnings(
#     st_write(sf_dw_system_loc_tribal_2, 
#              here('data_processed', 'drinking_water_systems_filtered', 
#                   'drinking_water_systems_filtered.shp'), 
#              quiet = TRUE)
# )
```

Tabular data (water systems / aquifers overlapping tribal boundaries):

```{r drinking-water-system-locations-tabular}
sf_dw_system_loc_tribal %>%
    st_drop_geometry() %>% 
    kbl() %>%
    kable_paper() %>%
    scroll_box(width = "1000px", height = "200px") %>%
    {.}
```


## Combined Risk

This dataset is not currently used in any of our analysis. It is available at:
<https://gis.data.ca.gov/datasets/waterboards::combined-risk/about>

```{r drinking-water-combined-risk}
# # get data via REST
# # this link comes from the "View Data Source" button
# sf_combined_risk <- esri2sf(
#     url = 'https://services.arcgis.com/Wvy1i2QPQwOxNumH/arcgis/rest/services/Combined_Risk/FeatureServer/0', 
#     crs = NULL) %>% 
#     st_transform(crs_projected) %>% 
#     rename(geom = geoms)
```


## Combined Risk By Well

This dataset is not currently used in any of our analysis. It is available at:
<https://gis.data.ca.gov/datasets/waterboards::water-quality-risk-by-well-all-chemicals/about>

See the "Water Quality Risk Final - Water Quality Risk by Well (All Contaminants)" dataset below for the version that is used in the shiny app. 


```{r drinking-water-combined-risk-by-well-download}
# # get data via REST
# # this link comes from the "View Data Source" button
# sf_dw_domestic_well <- esri2sf(
#     url = 'https://services.arcgis.com/Wvy1i2QPQwOxNumH/arcgis/rest/services/Domestic_Depth_Groundwater_Quality/FeatureServer/0', 
#     crs = NULL)
# # transform
# sf_dw_domestic_well <- sf_dw_domestic_well %>% 
#     st_transform(crs_projected) %>% 
#     rename(geom = geoms)
# # write
# st_write(sf_dw_domestic_well,
#          here('data', 'combined_risk_well.gpkg'),
#          append = FALSE)

sf_dw_domestic_well <- st_read(here('data', 'combined_risk_well.gpkg'))

# sf_dw_domestic_well %>% st_drop_geometry() %>% count(source)

# wells on tribal land
sf_dw_domestic_well_tribal <- sf_dw_domestic_well %>% 
    st_filter(sf_native_areas_census)
# sf_dw_domestic_well_tribal %>% st_drop_geometry() %>% View()
```

Here's a plot of wells within tribal boundaries, by risk level (blue = low, orange = medium, red = high):

```{r drinking-water-combined-risk-by-well-plot}
# high & medium risk wells
# sf_dw_domestic_well_tribal %>% st_drop_geometry() %>% filter(risk != 'low') %>% View()

# plot
plot_wells_combined_risk <- plot(sf_california$geom) + 
    plot(sf_native_areas_census$geom, col = 'black', add = TRUE) + 
    plot(sf_dw_domestic_well_tribal %>% 
             filter(risk == 'low') %>% 
             pull(geom), 
         col = 'blue', add = TRUE) +
    plot(sf_dw_domestic_well_tribal %>% 
             filter(risk == 'medium') %>% 
             pull(geom), 
         col = 'orange', add = TRUE) + 
    plot(sf_dw_domestic_well_tribal %>% 
             filter(risk == 'high') %>% 
             pull(geom), 
         col = 'red', add = TRUE)

# # write to shapefile
# suppressWarnings(
#     st_write(sf_dw_domestic_well_tribal, 
#              here('data_processed', 'wells_filtered', 
#                   'wells_filtered.shp'), 
#              quiet = TRUE)
# )
```

Tabular data (wells within tribal boundaries):
```{r drinking-water-combined-risk-by-well-tabular}
sf_dw_domestic_well_tribal %>%
    st_drop_geometry() %>% 
    kbl() %>%
    kable_paper() %>%
    scroll_box(width = "1000px", height = "200px")
```

Count of wells by risk level:
```{r drinking-water-combined-risk-by-well-count}
sf_dw_domestic_well_tribal %>% 
    st_drop_geometry() %>% 
    count(risk) %>% 
    # kbl() %>%
    # kable_paper() %>% 
    # scroll_box(width = "200px", height = "100px") %>% 
    {.}
```


## DWR OSWCR Well Data

This dataset is not currently used in any of our analysis. It is available at: <https://data.cnra.ca.gov/dataset/647afc02-8954-426d-aabd-eff418d2652c/resource/8da7b93b-4e69-495d-9caa-335691a1896b>

```{r drinking-water-wells-oswcr}
# # source data
# temp_dir <- tempdir()
# download.file(url = 'https://data.cnra.ca.gov/dataset/647afc02-8954-426d-aabd-eff418d2652c/resource/8da7b93b-4e69-495d-9caa-335691a1896b/download/wellcompletionreports.csv', 
#               destfile = file.path(temp_dir, 'wellcompletionreports.csv'))
# # write to zip file
# archive_write_files(archive = here('data', 'wellcompletionreports.zip'), 
#                     files = file.path(temp_dir, 'wellcompletionreports.csv'))

# read data
df_dwr_oswcr <- read_csv(here('data', 'wellcompletionreports.zip'),
                         guess_max = 100000)

# investigate / filter
dwr_oswcr_summary <- df_dwr_oswcr %>% 
    count(PLANNEDUSEFORMERUSE) %>% 
    arrange(desc(n)) %>% 
    # filter(!str_detect(string = tolower(PLANNEDUSEFORMERUSE),
    #                    pattern = 'destruction')) %>%
    # filter(str_detect(string = tolower(PLANNEDUSEFORMERUSE),
    #                   pattern = 'domestic')) %>%
    # filter(n > 10) %>% 
    {.}
# View(dwr_oswcr_summary)

dwr_oswcr_summary %>% 
    # st_drop_geometry() %>% 
    # count(risk) %>% 
    kbl() %>%
    kable_paper() %>%
    scroll_box(width = "300px", height = "200px") %>%
    {.}

# # convert to sf ---
# sf_dwr_oswcr <- st_as_sf(df_dwr_oswcr %>% 
#                              filter(!is.na(as.numeric(DECIMALLONGITUDE)), 
#                                     !is.na(as.numeric(DECIMALLATITUDE))), 
#                          coords = c('DECIMALLONGITUDE', 'DECIMALLATITUDE')) %>% 
#     st_set_crs(4326) %>% 
#     st_transform(crs_projected)
# 
# # filter by type and location ----
# sf_dwr_oswcr_filter <- sf_dwr_oswcr %>% 
#     filter(PLANNEDUSEFORMERUSE %in% c('Water Supply Domestic', 
#                                       'Water Supply Public', 
#                                       'Domestic')) %>% 
#     st_filter(sf_native_areas_census)
# 
# plot(sf_california$geom) + plot(sf_dwr_oswcr_filter$geometry, add = TRUE)
# View(sf_dwr_oswcr_filter %>% st_drop_geometry())
# 
# st_write(sf_dwr_oswcr_filter, here('data_processed', 'dwr_oswcr_filter.gpkg'))
```

## Water Quality Risk Final - Water Quality Risk by Well (All Contaminants)

This dataset was used by Alexis in the shiny app (in the "Wells + SSWS" tab). Emily Houlihan pointed him to this dataset as an updated version of the "Combined Risk By Well" dataset mentioned above, and this dataset also categorizes by well type. 

The dataset is avilable at: <https://gispublic.waterboards.ca.gov/portal/home/item.html?id=84dc4363570b42aba392952d8974c8ab>
Note that you have to then go to the "Water Quality Risk by Well (All Contaminants)" layer to get the well data.

```{r drinking-water-quality-final-download}
# # uncomment the code below to download and process the dataset
# # get data
# sf_wells_wq_risk <- esri2sf(
#     url = 'https://gispublic.waterboards.ca.gov/portalserver/rest/services/Hosted/Water_Quality_Risk_Final/FeatureServer/0',
#     crs = NULL)
# 
# # rename / reorder fields
# sf_wells_wq_risk <- sf_wells_wq_risk %>%
#     rename(geom = geoms) %>%
#     select(gm_well_id, prf1, prf2, prf3, pl1, pl2,
#            risk, gm_latitud, gm_longitu, gm_well_ca,
#            gm_dataset, mtrs, globalid, geom)
# 
# # write to geopackage file
# st_write(sf_wells_wq_risk,
#          here('data_processed', 'wells.gpkg'),
#          append = FALSE)
```

As a check, here's a plot of the wells that are within the Census Bureau boundaries: 

```{r drinking-water-quality-final-plot}
sf_wells_wq_risk <- st_read(here('data_processed', 'wells.gpkg'), 
                            quiet = TRUE) %>% 
    st_transform(crs_projected)

sf_wells_tribal <- sf_wells_wq_risk %>% 
    st_filter(sf_native_areas_census)

plot_wells_risk_final <- plot(sf_california$geom) + 
    plot(sf_wells_tribal$geom, col = 'blue', add = TRUE)
```


## State Small Water Systems

This dataset was used by Alexis in the shiny app (in the "Wells + SSWS" tab). 

The dataset is avilable at: <https://gispublic.waterboards.ca.gov/portal/home/item.html?id=2d34d39f75b8491d88adda57adb837ec&fromSearch=true&searchPosition=1&searchTerm=small%20state%20water%20systems>

```{r drinking-water-ssws-download}
# # uncomment the code below to download and process the dataset
# # get data
# sf_ssws <- esri2sf(
#     url = 'https://gispublic.waterboards.ca.gov/portalserver/rest/services/Hosted/State_Small_Water_Systems_DDW/FeatureServer/0',
#     crs = NULL)
# 
# # rename / reorder fields
# sf_ssws <- sf_ssws %>%
#     rename(geom = geoms) %>%
#     select(target_fid, pwsid, system_nam, related_ag, phys_addre,
#            phys_city, phys_state, phys_zip, address, phys_count,
#            admin_cont, admin_emai, admin_addr, admin_add2, admin_city,
#            admin_stat, admin_zip, service_co, population, svc_area_t,
#            owner_type, latitude, longitude, geoaddress, confidence,
#            geocode_me, geocode_ty, match_code, mtrs, srf1, srf2,
#            srf3, sl1, sl2, wqrskbn, globalid, geom)
# 
# # write to geopackage file
# st_write(sf_ssws,
#          here('data_processed', 'SSWS.gpkg'),
#          append = FALSE)
```

As a check, here's a plot of the systems that are within the Census Bureau boundaries: 

```{r drinking-water-ssws-plot}
sf_ssws <- st_read(here('data_processed', 
                        'SSWS.gpkg'), 
                   quiet = TRUE) %>% 
    st_transform(crs_projected)

sf_ssws_tribal <- sf_ssws %>% 
    st_filter(sf_native_areas_census)

plot_ssws <- plot(sf_california$geom) + 
    plot(sf_ssws_tribal$geom, col = 'blue', add = TRUE)
```
